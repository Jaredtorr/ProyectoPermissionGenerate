<app-header-student></app-header-student>

<app-complete-profile-modal
  [isOpen]="showCompleteProfileModal"
  [studentId]="studentId"
  [userId]="userId"
  [missingFields]="missingFields"
  [required]="true"
  (completed)="onProfileCompleted()"
  (closed)="showCompleteProfileModal = false">
</app-complete-profile-modal>

<div class="w-full px-4 py-8">
  <div class="w-[90%] mx-auto max-w-full">
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-[#003D6B] mb-2">Generar Permiso</h1>
      <p class="text-gray-600">Completa el formulario para solicitar tu permiso de ausencia</p>
    </div>

    <div *ngIf="!isProfileComplete" 
         class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6">
      <div class="flex items-start gap-3">
        <i class='bx bx-error text-yellow-600 text-2xl flex-shrink-0'></i>
        <div>
          <p class="font-semibold text-yellow-800">Perfil incompleto</p>
          <p class="text-yellow-700 text-sm mb-2">
            Necesitas completar tu perfil antes de solicitar permisos.
          </p>
          <button
            (click)="showCompleteProfileModal = true"
            class="bg-yellow-600 text-white px-4 py-2 rounded text-sm font-semibold hover:bg-yellow-700 transition-colors">
            Completar ahora
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="showSuccessMessage" 
         class="bg-green-50 border-l-4 border-green-500 p-4 mb-6 animate-fade-in">
      <div class="flex items-center">
        <i class='bx bx-check-circle text-green-500 text-2xl mr-3'></i>
        <div>
          <p class="font-semibold text-green-800">¡Permiso enviado exitosamente!</p>
          <p class="text-green-600 text-sm">Tu solicitud ha sido registrada y está pendiente de aprobación.</p>
        </div>
      </div>
    </div>

    <div *ngIf="errorMessage" 
         class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
      <div class="flex items-center">
        <i class='bx bx-error text-red-500 text-2xl mr-3'></i>
        <p class="text-red-800">{{ errorMessage }}</p>
      </div>
    </div>

    <form (ngSubmit)="onSubmit()" class="bg-white p-8 border border-gray-200 rounded-lg">
      <div class="mb-6">
        <label class="block text-gray-700 font-semibold mb-2">
          <i class='bx bx-user-circle mr-2'></i>Profesores * <span class="text-sm font-normal text-gray-500">(Puedes seleccionar varios)</span>
        </label>
        <div class="relative">
          <input
            type="text"
            [(ngModel)]="searchTeacher"
            name="searchTeacher"
            (input)="filterTeachers()"
            (focus)="showTeacherDropdown = true"
            [disabled]="!isProfileComplete"
            placeholder="Buscar profesor por nombre..."
            class="w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-[#00A3E0] focus:border-transparent outline-none transition-all disabled:bg-gray-100 disabled:cursor-not-allowed"
            required>
          
          <div *ngIf="showTeacherDropdown && filteredTeachers.length > 0"
               class="absolute z-10 w-full mt-1 bg-white border border-gray-200 max-h-60 overflow-y-auto">
            <div
              *ngFor="let teacher of filteredTeachers"
              (click)="selectTeacher(teacher)"
              class="px-4 py-3 hover:bg-[#00A3E0] hover:text-white cursor-pointer transition-colors flex items-center gap-2">
              <i class='bx bx-user'></i>
              <span>{{ teacher.informacionPersonal.nombreCompleto }}</span>
            </div>
          </div>

          <div *ngIf="showTeacherDropdown && filteredTeachers.length === 0 && searchTeacher"
               class="absolute z-10 w-full mt-1 bg-white border border-gray-200 p-4 text-gray-500 text-center">
            No se encontraron profesores
          </div>
        </div>
        
        <div *ngIf="selectedTeachers.length > 0" class="mt-3 space-y-2">
          <p class="text-sm text-gray-600 font-medium">
            <i class='bx bx-check-circle text-green-500'></i> 
            Profesores seleccionados ({{ selectedTeachers.length }}):
          </p>
          <div class="flex flex-wrap gap-2">
            <div *ngFor="let teacher of selectedTeachers"
                 class="bg-[#003D6B] text-white px-3 py-2 flex items-center gap-2 text-sm">
              <i class='bx bx-user'></i>
              <span>{{ teacher.informacionPersonal.nombreCompleto }}</span>
              <button
                type="button"
                (click)="removeTeacher(teacher.teacherId)"
                class="hover:bg-white/20 p-1 transition-colors">
                <i class='bx bx-x text-lg'></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div>
          <label class="block text-gray-700 font-semibold mb-2">
            <i class='bx bx-calendar mr-2'></i>Fecha de Inicio *
          </label>
          <input
            type="date"
            [(ngModel)]="startDate"
            name="startDate"
            [disabled]="!isProfileComplete"
            class="w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-[#00A3E0] focus:border-transparent outline-none transition-all disabled:bg-gray-100"
            required>
        </div>

        <div>
          <label class="block text-gray-700 font-semibold mb-2">
            <i class='bx bx-calendar-check mr-2'></i>Fecha de Fin *
          </label>
          <input
            type="date"
            [(ngModel)]="endDate"
            name="endDate"
            [min]="startDate"
            [disabled]="!isProfileComplete"
            class="w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-[#00A3E0] focus:border-transparent outline-none transition-all disabled:bg-gray-100"
            required>
        </div>
      </div>

      <div class="mb-6">
        <label class="block text-gray-700 font-semibold mb-2">
          <i class='bx bx-info-circle mr-2'></i>Motivo *
        </label>
        <select
          [(ngModel)]="reason"
          name="reason"
          [disabled]="!isProfileComplete"
          class="w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-[#00A3E0] focus:border-transparent outline-none transition-all cursor-pointer disabled:bg-gray-100"
          required>
          <option value="" disabled selected>Selecciona un motivo</option>
          <option *ngFor="let option of reasonOptions" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
      </div>

      <div class="mb-6">
        <label class="block text-gray-700 font-semibold mb-2">
          <i class='bx bx-detail mr-2'></i>Descripción *
        </label>
        <textarea
          [(ngModel)]="description"
          name="description"
          rows="4"
          [disabled]="!isProfileComplete"
          placeholder="Describe detalladamente el motivo de tu permiso..."
          class="w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-[#00A3E0] focus:border-transparent outline-none transition-all resize-none disabled:bg-gray-100"
          required></textarea>
      </div>

      <div class="mb-6">
        <label class="block text-gray-700 font-semibold mb-2">
          <i class='bx bx-book mr-2'></i>Cuatrimestre *
        </label>
        <input
          type="text"
          [(ngModel)]="cuatrimestre"
          name="cuatrimestre"
          [disabled]="!isProfileComplete"
          placeholder="Ej: 7"
          class="w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-[#00A3E0] focus:border-transparent outline-none transition-all disabled:bg-gray-100"
          required>
      </div>

      <div class="mb-8">
        <label class="block text-gray-700 font-semibold mb-2">
          <i class='bx bx-file mr-2'></i>Evidencia (PDF) *
        </label>
        <div class="relative">
          <input
            type="file"
            (change)="onFileSelected($event)"
            accept=".pdf"
            [disabled]="!isProfileComplete"
            class="hidden"
            #fileInput
            required>
          
          <button
            type="button"
            (click)="fileInput.click()"
            [disabled]="!isProfileComplete"
            class="w-full px-4 py-3 border-2 border-dashed border-gray-300 hover:border-[#00A3E0] hover:bg-blue-50 transition-all flex items-center justify-center gap-2 text-gray-600 disabled:bg-gray-100 disabled:cursor-not-allowed">
            <i class='bx bx-upload text-xl'></i>
            <span>{{ fileName || 'Seleccionar archivo PDF' }}</span>
          </button>
        </div>
        <p *ngIf="fileName" class="text-sm text-green-600 mt-2 flex items-center gap-1">
          <i class='bx bx-check-circle'></i>
          Archivo cargado: {{ fileName }}
        </p>
      </div>

      <div class="flex gap-4">
        <button
          type="submit"
          [disabled]="!isFormValid() || isSubmitting"
          class="flex-1 bg-[#003D6B] text-white px-6 py-3 font-semibold hover:bg-[#002D4B] disabled:bg-gray-300 disabled:cursor-not-allowed transition-all flex items-center justify-center gap-2">
          <i class='bx bx-send' [class.bx-spin]="isSubmitting"></i>
          <span>{{ isSubmitting ? 'Enviando...' : 'Enviar Permiso' }}</span>
        </button>

        <button
          type="button"
          (click)="resetForm()"
          [disabled]="isSubmitting || !isProfileComplete"
          class="px-6 py-3 border-2 border-gray-300 text-gray-700 font-semibold hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
          Limpiar
        </button>
      </div>
    </form>
  </div>
</div>