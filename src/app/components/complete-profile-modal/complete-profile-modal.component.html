<!-- Modal Overlay -->
<div *ngIf="isOpen" 
     class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
     (click)="onBackdropClick($event)">
  
  <!-- Modal Content -->
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto"
       (click)="$event.stopPropagation()">
    
    <!-- Header -->
    <div class="bg-gradient-to-r from-[#003D6B] to-[#00A3E0] p-6 rounded-t-2xl">
      <div class="flex items-center gap-3 text-white">
        <i class='bx bx-user-check text-4xl'></i>
        <div>
          <h2 class="text-2xl font-bold">Completa tu perfil</h2>
          <p class="text-blue-100 text-sm">Necesitamos algunos datos adicionales</p>
        </div>
      </div>
    </div>

    <!-- Body -->
    <form (ngSubmit)="onSubmit()" class="p-6 space-y-5">
      
      <!-- Mensaje informativo -->
      <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
        <div class="flex items-start gap-3">
          <i class='bx bx-info-circle text-blue-500 text-xl flex-shrink-0 mt-0.5'></i>
          <p class="text-sm text-blue-800">
            Para poder solicitar permisos, necesitamos que completes la siguiente informaci√≥n.
          </p>
        </div>
      </div>

      <!-- Error message -->
      <div *ngIf="errorMessage" 
           class="bg-red-50 border-l-4 border-red-500 p-4 rounded animate-shake">
        <div class="flex items-center gap-2">
          <i class='bx bx-error text-red-500 text-xl'></i>
          <p class="text-sm text-red-800">{{ errorMessage }}</p>
        </div>
      </div>

      <!-- Matr√≠cula -->
      <div *ngIf="missingFields.includes('enrollmentNumber')">
        <label class="block text-gray-700 font-semibold mb-2">
          <i class='bx bx-id-card mr-2'></i>Matr√≠cula *
        </label>
        <input
          type="text"
          [(ngModel)]="formData.enrollmentNumber"
          name="enrollmentNumber"
          placeholder="Ej: 2021030123"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00A3E0] focus:border-transparent outline-none transition-all"
          required>
        <p class="text-xs text-gray-500 mt-1">Tu n√∫mero de matr√≠cula oficial</p>
      </div>

      <!-- Tel√©fono Personal -->
      <div *ngIf="missingFields.includes('phone')">
        <label class="block text-gray-700 font-semibold mb-2">
          <i class='bx bx-phone mr-2'></i>Tel√©fono Personal *
        </label>
        <input
          type="tel"
          [(ngModel)]="formData.phone"
          name="phone"
          placeholder="Ej: 5512345678"
          maxlength="10"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00A3E0] focus:border-transparent outline-none transition-all"
          required>
        <p class="text-xs text-gray-500 mt-1">10 d√≠gitos sin espacios ni guiones</p>
      </div>

      <!-- Tel√©fono del Tutor Familiar -->
      <div *ngIf="missingFields.includes('familyTutorPhone')">
        <label class="block text-gray-700 font-semibold mb-2">
          <i class='bx bx-phone-call mr-2'></i>Tel√©fono de Tutor Familiar *
        </label>
        <input
          type="tel"
          [(ngModel)]="formData.familyTutorPhone"
          name="familyTutorPhone"
          placeholder="Ej: 5598765432"
          maxlength="10"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00A3E0] focus:border-transparent outline-none transition-all"
          required>
        <p class="text-xs text-gray-500 mt-1">Contacto de emergencia (padre, madre o tutor)</p>
      </div>

      <!-- Selector de Tutor -->
      <div *ngIf="missingFields.includes('tutorId')">
        <label class="block text-gray-700 font-semibold mb-2">
          <i class='bx bx-user-voice mr-2'></i>Selecciona tu Tutor Acad√©mico *
        </label>
        
        <div *ngIf="isLoadingTutors" class="flex items-center justify-center py-4">
          <i class='bx bx-loader-alt bx-spin text-2xl text-[#00A3E0]'></i>
          <span class="ml-2 text-gray-600">Cargando tutores...</span>
        </div>

        <select
          *ngIf="!isLoadingTutors"
          [(ngModel)]="formData.tutorId"
          name="tutorId"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00A3E0] focus:border-transparent outline-none transition-all"
          required>
          <option [ngValue]="undefined">Selecciona un tutor</option>
          <option *ngFor="let tutor of tutors" [ngValue]="tutor.tutor_id">
            {{ tutor.informacion_personal.nombre_completo }}
          </option>
        </select>
        
        <p class="text-xs text-gray-500 mt-1">Tu tutor ser√° notificado cuando solicites permisos</p>

        <!-- DEBUG INFO -->
        <div class="mt-3 p-3 bg-yellow-50 border-2 border-yellow-400 rounded-lg text-xs space-y-2">
          <p class="font-bold text-yellow-800">üîç Debug Info:</p>
          <p>‚Ä¢ isLoadingTutors: <strong>{{ isLoadingTutors }}</strong></p>
          <p>‚Ä¢ tutors.length: <strong>{{ tutors.length }}</strong></p>
          <p>‚Ä¢ formData.tutorId: <strong>{{ formData.tutorId || 'undefined' }}</strong></p>
          <div *ngIf="tutors.length > 0" class="mt-2 p-2 bg-white rounded">
            <p class="font-bold">Primer tutor:</p>
            <p class="text-xs">ID: {{ tutors[0].tutor_id }}</p>
            <p class="text-xs">Nombre: {{ tutors[0].informacion_personal.nombre_completo }}</p>
          </div>
          <div *ngIf="tutors.length === 0 && !isLoadingTutors" class="text-red-600 font-bold">
            ‚ö†Ô∏è Array de tutores est√° VAC√çO
          </div>
        </div>
      </div>

      <!-- Buttons -->
      <div class="flex gap-3 pt-4">
        <button
          type="submit"
          [disabled]="isSubmitting || !isFormValid()"
          class="flex-1 bg-[#003D6B] text-white px-6 py-3 rounded-lg font-semibold hover:bg-[#002D4B] disabled:bg-gray-300 disabled:cursor-not-allowed transition-all flex items-center justify-center gap-2">
          <i class='bx bx-save' [class.bx-spin]="isSubmitting"></i>
          <span>{{ isSubmitting ? 'Guardando...' : 'Guardar' }}</span>
        </button>

        <button
          *ngIf="!required"
          type="button"
          (click)="onClose()"
          [disabled]="isSubmitting"
          class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
          Despu√©s
        </button>
      </div>

      <!-- Nota si es obligatorio -->
      <p *ngIf="required" class="text-xs text-center text-gray-500 pt-2">
        <i class='bx bx-lock-alt'></i>
        Debes completar estos datos para continuar
      </p>

    </form>

  </div>
</div>